<script>
  // Initialize Firebase
  var firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let entriesRef = null;

  firebase.auth().onAuthStateChanged((user) => {
    if (user) {
      const uid = user.uid;
      entriesRef = db.collection("users").doc(uid).collection("entries");

      // Load entries
      entriesRef.orderBy("timestamp", "desc").onSnapshot((snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === "added") {
            const entry = change.doc.data();
            renderEntry(change.doc.id, entry); // use your existing render function
          }
        });
      });

      // Submit entry
      document.getElementById("entryForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const entryText = document.getElementById("entryText").value.trim();
        const selectedCategory = document.getElementById("categorySelect").value;
        const selectedFont = document.getElementById("fontSelect").value;
        const sharedPassword = document.getElementById("passwordInput").value;
        const uploadedImageUrl = uploadedImage || "";

        if (entryText === "") return;

        entriesRef.add({
          text: entryText,
          sender: "You",
          category: selectedCategory,
          font: selectedFont,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          replies: [],
          image: uploadedImageUrl,
          sharedPassword: sharedPassword
        }).then(() => {
          document.getElementById("entryForm").reset();
          showToast("Entry saved!");
        }).catch((error) => {
          console.error("Error writing entry:", error);
          showToast("Failed to save entry.");
        });
      });

      // Keep your delete & reply functions working:
      window.deleteEntry = function (id) {
        entriesRef.doc(id).delete().then(() => {
          showToast("Entry deleted.");
        });
      };

      window.addReply = function (id, replyText) {
        entriesRef.doc(id).update({
          replies: firebase.firestore.FieldValue.arrayUnion({
            text: replyText,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          })
        });
      };

    } else {
      // Not signed in â€” anonymous sign-in
      firebase.auth().signInAnonymously().catch((error) => {
        console.error("Auth error:", error.message);
        showToast("Authentication failed.");
      });
    }
  });
</script>
