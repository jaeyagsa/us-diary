<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [head section remains the same as before] -->
</head>
<body>
<!-- [HTML layout remains unchanged] -->

<script>
const PASSWORD = 'usdiary2025';

const firebaseConfig = {
  apiKey: "AIzaSyDtHj92IVoxoyz2EtMVaaHVKyPP7UHDpEU",
  authDomain: "unspoken-hearts-diary.firebaseapp.com",
  projectId: "unspoken-hearts-diary",
  storageBucket: "unspoken-hearts-diary.appspot.com",
  messagingSenderId: "885095961873",
  appId: "1:885095961873:web:4b4c846cc2b28dbce928b0",
  measurementId: "G-2L9NESBKWN"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();
emailjs.init('QuFveASS-r2Favhcs');

if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark');

function checkPassword() {
  const input = document.getElementById('passwordInput').value;
  if (input === PASSWORD) {
    document.querySelector('.password-screen').style.display = 'none';
    loadEntries();
  } else {
    alert('Incorrect password');
  }
}

function submitEntry() {
  const text = document.getElementById('entryText').value;
  const sender = document.getElementById('entrySender').value;
  const category = document.getElementById('entryCategory').value;
  const font = document.getElementById('fontSelector').value;
  const fileInput = document.getElementById('entryImage');
  const file = fileInput.files[0];
  const uploadingStatus = document.getElementById('uploadingStatus');

  if (!text.trim() && !file) return alert('Please write something or attach an image.');

  const entryData = { text, sender, category, font, timestamp: Date.now(), replies: [] };

  if (file) {
    uploadingStatus.style.display = 'block';
    const storageRef = storage.ref().child('images/' + Date.now() + '_' + file.name);
    storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL()).then(url => {
      entryData.image = url;
      saveEntry(entryData);
      uploadingStatus.style.display = 'none';
      fileInput.value = '';
    }).catch(error => {
      uploadingStatus.style.display = 'none';
      alert('Image upload failed: ' + error.message);
    });
  } else {
    saveEntry(entryData);
    fileInput.value = '';
  }
}

function saveEntry(data) {
  db.collection('entries').add(data).then(() => {
    document.getElementById('entryText').value = '';
    loadEntries();
  });
}

function loadEntries() {
  const selectedCategory = document.getElementById('filterCategory').value;
  db.collection('entries').orderBy('timestamp', 'desc').get().then(snapshot => {
    const container = document.getElementById('entries');
    container.innerHTML = '';
    const dump = document.getElementById('photoDump');
    dump.innerHTML = '';

    snapshot.forEach(doc => {
      const data = doc.data();
      if (selectedCategory !== 'All' && data.category !== selectedCategory) return;

      const div = document.createElement('div');
      div.className = 'diary-entry ' + data.sender;
      div.style.fontFamily = data.font || 'Arial, sans-serif';
      const timeString = new Date(data.timestamp).toLocaleString();

      let repliesHtml = '';
      (data.replies || []).forEach((r, index) => {
        const replyTime = r.timestamp ? new Date(r.timestamp).toLocaleString() : '';
        repliesHtml += `<p>${r.text}<br><small>${replyTime}</small> <button onclick="deleteReply('${doc.id}', ${index})">🗑️</button></p>`;
      });

      div.innerHTML = `
        <strong>Category: ${data.category || 'General'}</strong><br>
        <small>${timeString}</small>
        <p>${data.text || ''}</p>
        ${data.image ? `<img src="${data.image}" alt="Attached Image">` : ''}
        <div class="reply-block">
          ${repliesHtml}
          <input type="text" placeholder="Reply..." id="reply-${doc.id}">
          <button onclick="addReply('${doc.id}')">↩️</button>
          <button onclick="deleteEntry('${doc.id}')">🗑️</button>
        </div>
      `;

      container.appendChild(div);
      if (data.image) {
        const img = document.createElement('img');
        img.src = data.image;
        dump.appendChild(img);
      }
    });
  });
}

function addReply(id) {
  const replyInput = document.getElementById(`reply-${id}`);
  const replyText = replyInput.value;
  if (!replyText.trim()) return;

  const replyWithTime = { text: replyText, timestamp: Date.now() };
  db.collection('entries').doc(id).update({
    replies: firebase.firestore.FieldValue.arrayUnion(replyWithTime)
  }).then(() => {
    replyInput.value = '';
    loadEntries();
  });
}

function deleteReply(entryId, index) {
  const entryRef = db.collection('entries').doc(entryId);
  entryRef.get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      data.replies.splice(index, 1);
      entryRef.update({ replies: data.replies });
    }
  });
}

function deleteEntry(id) {
  if (confirm('Delete this entry?')) db.collection('entries').doc(id).delete().then(loadEntries);
}

function sendMood(mood) {
  emailjs.send('service_g01f5f1', 'template_vzvlohc', {
    to_email: 'kaito2epic@gmail.com',
    mood: mood
  }).then(() => alert('Mood sent!')).catch(() => alert('Failed to send mood.'));
}

function createFloatingHearts() {
  const container = document.querySelector('.floating-hearts');
  setInterval(() => {
    const heart = document.createElement('div');
    heart.className = 'heart';
    heart.style.left = Math.random() * 100 + '%';
    heart.style.background = ['#ff99cc', '#ff66b2', '#ffb6c1', '#ffcce6'][Math.floor(Math.random() * 4)];
    container.appendChild(heart);
    setTimeout(() => heart.remove(), 8000);
  }, 800);
}
createFloatingHearts();
</script>
</body>
</html>
