// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDtHj92IVoxoyz2EtMVaaHVKyPP7UHDpEU",
  authDomain: "unspoken-hearts-diary.firebaseapp.com",
  projectId: "unspoken-hearts-diary",
  storageBucket: "unspoken-hearts-diary.appspot.com",
  messagingSenderId: "885095961873",
  appId: "1:885095961873:web:4b4c846cc2b28dbce928b0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();
emailjs.init('QuFveASS-r2Favhcs');

const PASSWORD = 'usdiary2025';

function checkPassword() {
  const input = document.getElementById('passwordInput').value;
  if (input === PASSWORD) {
    document.querySelector('.password-screen').style.display = 'none';
  } else {
    alert('Incorrect password');
  }
}

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
}

function submitEntry() {
  const text = document.getElementById('entryText').value;
  const sender = document.getElementById('entrySender').value;
  const category = document.getElementById('entryCategory').value;
  const font = document.getElementById('fontSelector').value;
  const file = document.getElementById('entryImage').files[0];

  if (!text.trim() && !file) {
    alert('Please write something or attach an image.');
    return;
  }

  const entryData = {
    text,
    sender,
    category,
    font,
    timestamp: Date.now(),
    replies: []
  };

  if (file) {
    const storageRef = storage.ref('images/' + Date.now() + '_' + file.name);
    storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL())
      .then(url => {
        entryData.image = url;
        saveEntry(entryData);
      });
  } else {
    saveEntry(entryData);
  }
}

function saveEntry(data) {
  db.collection('entries').add(data).then(() => {
    document.getElementById('entryText').value = '';
    document.getElementById('entryImage').value = '';
  });
}

function loadEntries() {
  const selectedCategory = document.getElementById('filterCategory').value;
  db.collection('entries').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
    const container = document.getElementById('entries');
    container.innerHTML = '';
    const dump = document.getElementById('photoDump');
    dump.innerHTML = '';

    snapshot.forEach(doc => {
      const data = doc.data();
      if (selectedCategory !== 'All' && data.category !== selectedCategory) return;

      const div = document.createElement('div');
      div.className = 'diary-entry ' + data.sender;
      div.style.fontFamily = data.font || 'Arial, sans-serif';

      const timeString = new Date(data.timestamp).toLocaleString();

      div.innerHTML = `
        <strong>Category: ${data.category || 'General'}</strong><br>
        <small>${timeString}</small>
        <p>${data.text || ''}</p>
        ${data.image ? `<img src="${data.image}">` : ''}
        <div class="reply">
          ${(data.replies || []).map(r => `<p>${r.text}<small>${new Date(r.time).toLocaleString()}</small></p>`).join('')}
          <input type="text" placeholder="Reply..." id="reply-${doc.id}">
          <button onclick="addReply('${doc.id}')">‚Ü©Ô∏è</button>
          <button onclick="deleteEntry('${doc.id}')">üóëÔ∏è</button>
        </div>
      `;

      container.appendChild(div);

      if (data.image) {
        const img = document.createElement('img');
        img.src = data.image;
        dump.appendChild(img);
      }
    });
  });
}

function addReply(id) {
  const replyInput = document.getElementById(`reply-${id}`);
  const replyText = replyInput.value;
  if (!replyText.trim()) return;

  const entryRef = db.collection('entries').doc(id);
  entryRef.update({
    replies: firebase.firestore.FieldValue.arrayUnion({
      text: replyText,
      time: Date.now()
    })
  }).then(() => {
    replyInput.value = '';
  });
}

function deleteEntry(id) {
  if (confirm('Delete this entry?')) {
    db.collection('entries').doc(id).delete();
  }
}

function sendMood(mood) {
  const templateParams = {
    to_email: 'kaito2epic@gmail.com',
    mood: mood
  };

  emailjs.send('service_g01f5f1', 'template_vzvlohc', templateParams)
    .then(() => alert('Mood sent!'))
    .catch(() => alert('Failed to send mood.'));
}

loadEntries();
